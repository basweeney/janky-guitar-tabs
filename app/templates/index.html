<!DOCTYPE html>
<html>
<head>
  <title>Guitar Tab Capture</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <h1>ðŸŽ¸ Guitar Tab Generator</h1>

  <form id="urlForm">
    <label for="url">YouTube URL:</label><br>
    <input type="text" id="url" name="url" placeholder="Enter YouTube URL" required><br><br>
  </form>

  <div id="videoContainer"></div>
  <div id="result"></div>

  <script>
    document.getElementById("urlForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const youtube_url = document.getElementById("url").value;

      const response = await fetch("/tabs/fetch_video_info", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ youtube_url })
      });

      const data = await response.json();
      const videoContainer = document.getElementById("videoContainer");

      // Show the thumbnail or embed video
      videoContainer.innerHTML = `
        <img id="videoThumb" src="${data.thumbnail_url}" width="480">
        <form id="roiForm">
          <label>Start Buffer (seconds): <input type="number" id="start_buffer" value="3"></label>
          <label>End Buffer (seconds): <input type="number" id="end_buffer" value="5"></label>
          <button type="submit">Generate Tabs</button>
        </form>
      `;

      const roiForm = document.getElementById("roiForm");
      roiForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Disable submit button to prevent multiple submissions
        const submitButton = e.target.querySelector("button[type='submit']");
        submitButton.disabled = true;

        const data = {
          youtube_url: document.getElementById("url").value,
          start_buffer: parseInt(document.getElementById("start_buffer").value),
          end_buffer: parseInt(document.getElementById("end_buffer").value),
          roi: rect // replace with your actual ROI data
        };

        try {
          const response = await fetch("/tabs/process_video", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });

          const resultDiv = document.getElementById("result");
          if (response.ok) {
            const result = await response.json();
            resultDiv.innerHTML = `
              <p>${result.message}</p>
              <a href="/static/${result.output}" target="_blank">Download PDF</a>
            `;
          } else {
            resultDiv.innerHTML = `<p>Error: ${response.status}</p>`;
          }
        } catch (err) {
          document.getElementById("result").innerHTML = `<p>Request failed: ${err}</p>`;
        } finally {
            // Re-enable submit button
          submitButton.disabled = false;
        }
      });

    });
  </script>

</body>
</html>
